---
title: "Young water fraction estimation"
author: "Tam V. Nguyen"
date: "`r Sys.Date()`"
output: 
  rmdformats::readthedown:
    toc_depth: 5
bibliography: references.bib
---

```{css, echo = FALSE}
    #content{
        max-width:5000px;
    }
``` 
    
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## 1. Introduction

This document describes how the young water fraction is calculated based on the 
traditional [@Kirchner2016] and proposed (this study) procedures using the Fyw package. 
All results in the submitted manuscript mentioned below can be reproduced by 
running the R scripts provided here.

Tam V. Nguyen et al. (2023). Revisiting the Procedure 
for Quantifying the Young Water Fraction Based on Seasonal Tracer Cycles.
Manuscript submitted to Water Resources Research.

To run the code in this document, you need to install: 

-   <a href="https://www.r-project.org/" target="_blank">R (\>= 4.2.2)</a> 

-   <a href="https://posit.co/download/rstudio-desktop/" target="_blank">RStudio (\>= 2022.02.0)</a>

-   <a href="https://github.com/tamnva/Fyw" target="_blank">Fyw</a> package

Then download the project of this documentation <a href="https://github.com/tamnva/Fyw_supporting_information" target="_blank"> Fyw_supporting_information</a> and extract the *.zip* file. Go to the extract folder 
click to the project file *SuppInfo.Rproj*, the project will be automatically open 
with RStudio and now you are in the project folder.

Load the following packages (or install if you haven't installed them)

```{r, message=FALSE, warning = FALSE}
library(Fyw)             # Estimating young water fraction
library(ggplot2)         # Creating ggplot object
library(lubridate)       # Converting date to decimal
library(zoo)             # Linear interpolation of time series data
library(egg)             # Arranging multiple ggplot objects
library(ggpubr)          # Text annotation
library(tibble)
```

## 2. Data processing and exploration

We used the isotope and meteorological data from the Alp and Erlenbach catchments 
located in Switzerland [@Freyberg2022]. Below is the R script for retrieving and 
reprocessing the data. The data were already included in the Fyw package, in 
other words, these data will be automatically loaded when calling the Fyw package. 
Therefore, running the line of code starting with "source('R/preProcessingData.R')" 
is only optional.

```{r, eval= FALSE}

# The next line of code could be skipped because data were already included in the Fyw package
# source('R/preProcessingData.R')

# Information about the data
?isotopeData
```

Display and visualization of the data (isotope composition in precipitation and streamflow, precipitation and streamflow) from the Alp and Erlenbach catchments. From here on, we refer "P" to precipitation and "S" to streamflow.

```{r, fig.width = 12, fig.height = 3, fig.align = 'center', eval = TRUE}
# Display the data
isotopeData

# Create list object to store plot
plt <- list()

# Plot isotope data in precipitation and streamflow
plt[[1]] <- ggplot(isotopeData) +
  geom_point(aes(x = date, 
                 y = delta_18O, 
                 col = variable, 
                 shape = variable), 
             alpha = 0.5)+
  facet_grid(cols = vars(catchment))+ 
  scale_color_manual(name = "", 
                     values=c("gray", "blue", NA, NA), 
                     labels = c(expression("c"[P]), expression("c"[S]),NA, NA))+ 
  scale_shape_manual(name = "", 
                     values=c(16, 3, NA, NA), 
                     labels = c(expression("c"[P]), expression("c"[S]), NA, NA))+
  labs(x = "", 
       y = expression(paste(delta^{18}, "O in P and S (‰)")), 
       color = "") +
  theme_bw() +
  theme(legend.position = "none")

# Plot precipitation (P) and streamflow (S)
plt[[2]] <- ggplot(isotopeData) +
  geom_point(aes(x = date, 
                 y = water_flux_mm, 
                 col = variable, 
                 shape = variable), 
             alpha = 0.5)+
  facet_grid(cols = vars(catchment))+ 
  scale_color_manual(name = "",
                     values=c("gray", "blue", NA, NA), 
                     labels = c("P", "S",NA, NA))+ 
  scale_shape_manual(name = "",
                     values=c(16, 3, NA, NA), 
                     labels = c("P", "S", NA, NA))+ 
  labs(x = "", y = "P or S (mm/day)", color = "") + 
  theme_bw() +
  theme(legend.position = "right")

# Arrange plots in to 2 rows and 2 columns
ggarrange(plt[[1]], plt[[2]], ncol = 2, nrow = 1)
```

## 3. Young water fraction estimation

Extracting data from 'isotopeData' for each catchment separately

```{r}
# Extract data 
catchmentName <- unique(isotopeData$catchment)

# Extracted data as list
isotopeP <- list()
isotopeS <- list()

# Get isotope in precipitation (P) and streamflow (S) for the Alp & Erlenbach
for (i in 1:2){
  isotopeP[[i]] <- subset(isotopeData, 
                          catchment == catchmentName[i] & variable == "precipitation")
  isotopeS[[i]] <- subset(isotopeData, 
                          catchment == catchmentName[i] &  variable == "streamflow")
}
```

### 3.1. Traditional procedure

The procedure for finding the young water fraction and the transit time distribution in the traditional procedure is as follows:

-   Step 1: Fit the sine-wave to observed isotope in precipitation, e.g., using the iteratively least squares (IRLS) regression approach. The sine-wave used for fitting has the following form :

    $$ c_P(t) = a_P \cdot cos(2 \pi t) + b_P \cdot sin(2 \pi t) + k_P $$

```{r, fig.width=10,fig.height=3, fig.align = 'center'}
# Create a list object to store results from the traditional procedure
traditionalProcedure <- list()
traditionalProcedure$fitSineP <- list()

# Loop over each catchment
for (i in 1:2){
  # Get date of observed in decimal
  t <- decimal_date(isotopeP[[i]]$date) - trunc(decimal_date(isotopeP[[i]]$date))
  
  # Fit to sine wave to observed isotope in P using IRLS method
  traditionalProcedure$fitSineP[[i]] <- IRLS(Y = isotopeP[[i]]$delta_18O, 
                                             X = data.frame(cos = cos(2*pi*t), sin = sin(2*pi*t)), 
                                             pweights = isotopeP[[i]]$water_flux_mm)
}

# Plot to see the fitted sine-wave to observed isotope composition in precipitation
for (i in 1:2){
 plt[[i]] <- ggplot()+
  geom_point(data = isotopeP[[i]], 
             aes(x = date, 
                 y = delta_18O, 
                 color = "cP (observed)"), 
             alpha = 0.5) + 
  geom_line(aes(x = isotopeP[[i]]$date, 
                y = as.numeric(traditionalProcedure$fitSineP[[i]]$fitted.values), 
                color = "cP (fitted sine-wave)"), 
            linewidth = 0.75) +
  scale_color_manual(values = c("cP (observed)" = "gray", "cP (fitted sine-wave)" = "blue"), 
                     guide = guide_legend(override.aes = list(linetype = c("solid", "blank"), 
                                                              shape = c(NA, 19)))) +
  labs(x = "", 
       y = expression(paste(delta^{18}, "O in P(‰)")), 
       title = catchmentName[i], color = "") +
  theme_bw() +
  theme(legend.position = "bottom")
}

# Arrange and display plots
ggarrange(plt[[1]], plt[[2]], ncol = 2, nrow = 1)
```

-   Step 2: Fit the sine-wave to observed isotope in streamflow, e.g., using IRLS. The sine-wave used for fitting has the following form:

    $$ c_S(t) = a_S \cdot cos(2 \pi t) + b_P \cdot sin(2 \pi t) + k_S $$

```{r, fig.width=10,fig.height=3, fig.align = 'center'}

# Loop over each catchment
for (i in 1:2){
  # Get date of observed in decimal
  t <- decimal_date(isotopeS[[i]]$date) - trunc(decimal_date(isotopeS[[i]]$date))
  
  # Fit to sine wave to observed isotope in P using IRLS method
  traditionalProcedure$fitSineS[[i]] <- 
    IRLS(Y = isotopeS[[i]]$delta_18O, 
         X = data.frame(cos = cos(2*pi*t), sin = sin(2*pi*t)), 
         pweights = isotopeS[[i]]$water_flux_mm)
}

# Plot to see the fitted sine-wave to observed isotope in precipitation
for (i in 1:2){
  plt[[i]] <- ggplot()+
  geom_point(data = isotopeS[[i]], 
             aes(x = date, y = delta_18O, color = "cS (observed)"), 
             alpha = 0.5) + 
  geom_line(aes(x = isotopeS[[i]]$date, 
                y = as.numeric(traditionalProcedure$fitSineS[[i]]$fitted.values), 
                color = "cS (fitted sine-wave)"), 
            linewidth = 0.75) +
  scale_color_manual(values = c("cS (observed)" = "gray", 
                                "cS (fitted sine-wave)" = "blue"), 
                     guide = guide_legend(override.aes = 
                                            list(linetype = c("solid", "blank"), 
                                                 shape = c(NA, 19))))+
  labs(x = "", 
       y = expression(paste(delta^{18}, "O in S (‰)")), 
       title = catchmentName[i], color = "") +
  theme_bw() + 
  theme(legend.position = "bottom")
}

# Arrange and display plots
ggarrange(plt[[1]], plt[[2]], ncol = 2, nrow = 1)
```

-   Step 3: Infer the transit time (parameters of the gamma) distribution and Fyw

```{r, fig.width=10,fig.height=3, fig.align = 'center', eval = TRUE}

for (icatchment in 1:2){
  # Coefficient of the sine-wave cP = aP*cos(2*pi*t) + aP*sin(2*pi*t) + kP
  traditionalProcedure$kP[icatchment] <- as.numeric(traditionalProcedure$fitSineP[[icatchment]]$coefficients[1])
  traditionalProcedure$aP[icatchment] <- as.numeric(traditionalProcedure$fitSineP[[icatchment]]$coefficients[2])
  traditionalProcedure$bP[icatchment] <- as.numeric(traditionalProcedure$fitSineP[[icatchment]]$coefficients[3])

  # Coefficient of the sine-wave cS = aS*cos(2*pi*t) + aS*sin(2*pi*t) + kS
  traditionalProcedure$kS[icatchment] <- as.numeric(traditionalProcedure$fitSineS[[icatchment]]$coefficients[1])
  traditionalProcedure$aS[icatchment] <- as.numeric(traditionalProcedure$fitSineS[[icatchment]]$coefficients[2])
  traditionalProcedure$bS[icatchment] <- as.numeric(traditionalProcedure$fitSineS[[icatchment]]$coefficients[3])
  
  # Find amplitudes AP and AS
  traditionalProcedure$AP[icatchment] <- sqrt(sum(traditionalProcedure$aP[icatchment]^2 + 
                                                  traditionalProcedure$bP[icatchment]^2))
  traditionalProcedure$AS[icatchment] <- sqrt(sum(traditionalProcedure$aS[icatchment]^2 +
                                                  traditionalProcedure$bS[icatchment]^2))
  
  # Find phiS, phiP and the phase shift phiS - phiP
  phi <- findPhiPhaseShift(aP = traditionalProcedure$aP[icatchment], 
                           bP = traditionalProcedure$bP[icatchment], 
                           aS = traditionalProcedure$aS[icatchment], 
                           bS = traditionalProcedure$bS[icatchment])

  traditionalProcedure$phiP[icatchment] <- phi$phiP
  traditionalProcedure$phiS[icatchment] <- phi$phiS
  traditionalProcedure$phiS_phiP[icatchment] <- phi$phiS_phiP

  # Find parameters of the gamma distribution (alpha, beta)
  alphaBeta <- findAlphaBetaMTT(phiS_phiP = traditionalProcedure$phiS_phiP[icatchment], 
                                AS = traditionalProcedure$AS[icatchment], 
                                AP = traditionalProcedure$AP[icatchment])
  
  traditionalProcedure$alpha[icatchment] <- alphaBeta$alpha
  traditionalProcedure$beta[icatchment] <- alphaBeta$beta
  
  # Find age threshold of young water fraction
  traditionalProcedure$tauyw[icatchment] <-  0.0949 + 
    0.1065*traditionalProcedure$alpha[icatchment] - 
    0.0126*traditionalProcedure$alpha[icatchment]^2
  
  # Young water fraction = AS/AP
  traditionalProcedure$ASAPratio[icatchment] <-  traditionalProcedure$AS[icatchment]/
                                                 traditionalProcedure$AP[icatchment]
  
  # Young water fraction from gamma distribution with found tauyw and gamma distribution
  traditionalProcedure$Fyw[icatchment] <- pgamma(q = traditionalProcedure$tauyw[icatchment], 
                                                 shape = traditionalProcedure$alpha[icatchment], 
                                                 scale = traditionalProcedure$beta[icatchment],
                                                 lower.tail = TRUE)
}

# Assembling the above results (step 3) into a table
source('R/summaryResult.R')
traditionalProcedure$summaryResult <- summaryResult(traditionalProcedure)

# Display the result
traditionalProcedure$summaryResult

```

### 3.2. proposed procedure
-   Step 1: Fit the sine-wave to observed isotope in precipitation. 
The sine-wave used for fitting has the following form:

    $$ c_P(t) = A_P \cdot sin(2 \pi t - \varphi_P ) +  k_P $$

In the below R script, we generate 10k parameter sets (nIter) with Latin Hypercube
Samling with the respective given parameter range (AP = [1,3], phiP = (0, 2*pi), and
kP = [-12,-8]), then we save results from the best 1 parameter set (evaluated by the
weighted mean square error, the weights are precipitation volume)

```{r, fig.width=10,fig.height=3, fig.align = 'center', eval = TRUE}

# Create a list object to stored the results
revisedProcedure <- list()

# Fit Sine-wave to observed isotope data, setSeed = 2023 to reproduce exact results
for (catchment in 1:2){
  revisedProcedure$fitSineP[[catchment]] <- 
    fitSineNL(observed = isotopeP[[catchment]]$delta_18O,
              a = c(1,3),
              phi = c(0, 2*pi),
              k = c(-12,-8), 
              t = isotopeP[[catchment]]$date,
              nIter = 100000,
              nBestIter = 1, 
              weight = isotopeP[[catchment]]$water_flux_mm,
              setSeed = 2023)
}
```

Plot the best fitted-sine wave from the proposed procedures and compared it with
observed data and the traditional approach

```{r, fig.width=10,fig.height=3, fig.align = 'center'}
# Save plot as list object 
plt <- list()

# Plot the result
for (i in 1:length(catchmentName)){
  plt[[i]] <- ggplot()+
    geom_point(data = isotopeP[[i]], 
               aes(x = date, y = delta_18O, color = "cP (observed)"), 
               alpha = 0.35) + 
    geom_point(aes(x = isotopeP[[i]]$date, 
                   y = as.numeric(traditionalProcedure$fitSineP[[i]]$fitted.values), 
                   color = "cP (traditional procedure)"), 
               shape = 2, 
               alpha = 0.5) +
    geom_line(data = revisedProcedure$fitSineP[[i]]$simulated, 
              aes(x = date, 
                  y = simulated, 
                  color = "cP (proposed procedure)"), 
              linewidth = 0.75) +
    scale_color_manual(values = c("cP (observed)" = "gray",  
                                  "cP (proposed procedure)" = "red", 
                                  "cP (traditional procedure)" = "blue"), 
                       guide = guide_legend(override.aes = 
                                              list(linetype = c("blank","solid", "blank"), 
                                                   shape = c(19, NA, 2))))+
    labs(x = "", 
         y = expression(paste(delta^{18}, "O in precipitation (‰)")), 
         title = catchmentName[i], 
         color = "")+
    theme_bw()+
    theme(legend.position = "none") 
 
 # Add legend to second plot
 if (i == 2) plt[[i]] <- plt[[i]] + theme(legend.position = "right")
}

# Arrange and display plot
ggarrange(plt[[1]], plt[[2]], ncol = 2, nrow = 1, widths = c(0.65, 1))
```

-   Step 2: Find parameters of the transit time (gamma) distribution by fitting
the convolution of the sine-wave (above) with the gamma distribution with observed
instream isotope composition. This step is computationally demanding and 
it should be run parallel in a computer cluster.

```{r, fig.width=10,fig.height=3, fig.align = 'center', eval = FALSE}

# WARNING: THIS STEP REQUIRES VERY HIGH COMPUTATIONAL DEMAND - Around 12 hours/50 cores

# Fit Gamma using observed instream isotope composition
#    Here we show the code, if this code was not run, then the results can be 
#    obtained from our run with this setting in the next R script.

for (icatchment in 1:2){
revisedProcedure$fitGamma[[icatchment]] <- 
  fitGamma(AP = revisedProcedure$fitSineP[[icatchment]]$parameter$a[1], 
           phiP = revisedProcedure$fitSineP[[icatchment]]$parameter$phi[1],
           kP = revisedProcedure$fitSineP[[icatchment]]$parameter$k[1], 
           alphaRange = c(0.01,5),
           betaRange = c(0.01,5), 
           simulatedDate = isotopeS[[icatchment]]$date,
           fittedData = isotopeS[[icatchment]]$delta_18O, 
           weight = isotopeS[[icatchment]]$water_flux_mm,
           nIter = 100000, 
           nBestIter = 100, 
           nCores = 100, 
           nWarmupYears = 10,
           setSeed = 2023)
}

# Save result
save(revisedProcedure, file = "revisedProcedure.rda")
```

Now compare the simulated instream isotope composition from the traditional 
approach with the fitted sine-wave to observed isotope in streamflow
from the traditional approach.

```{r, fig.width=12,fig.height=3, fig.align = 'center', eval = TRUE}
# Load the results (uncomment the next line) if users does not run the previous R script
 load('data/revisedProcedure.rda')

# Plot the fitted results and compared with the traditional and observed data
for (i in 1:2){
 plt[[i]] <- ggplot()+
  geom_point(data = isotopeS[[i]], 
             aes(x = date, y = delta_18O, color = "cS (observed)"), 
             alpha = 0.5) + 
  geom_line(data = revisedProcedure$fitGamma[[i]]$simulated, 
            aes(x = date, 
                y = simulated, 
                group = simulation, 
                color = "cS (proposed procedure - top 100)"), 
            alpha = 0.8, 
            linewidth = 0.1)+
  geom_line(aes(x = isotopeS[[i]]$date, 
                y = as.numeric(traditionalProcedure$fitSineS[[i]]$fitted.values),  
                color = "cS (traditional procedure)"), 
            linewidth=0.75) +
  geom_line(data = subset(revisedProcedure$fitGamma[[i]]$simulated, 
                          simulation == "simulation_1"), 
            aes(x = date,
                y = simulated, 
                color = "cS (proposed procedure - best)"),
            linewidth = 0.75)+
  scale_color_manual(values = c("cS (proposed procedure - top 100)" = "pink", 
                                "cS (observed)" = "gray", 
                                "cS (proposed procedure - best)" = "red", 
                                "cS (traditional procedure)" = "blue"), 
                     guide = guide_legend(override.aes = 
                                            list(linetype = c("blank","solid","solid", "solid"),
                                                 shape = c(19, NA, NA, NA)))) +
  labs(x = "", 
       y = expression(paste(delta^{18}, "O in streamflow (‰)")), 
       title = catchmentName[i], 
       color = "")+
  theme_bw() +
  theme(legend.position = "none") 
 
 # Add legend to second plot
 if (i == 2) plt[[i]] <- plt[[i]] + theme(legend.position = "right")
}

# Arrange and display plot
ggarrange(plt[[1]], plt[[2]], ncol = 2, nrow = 1, widths = c(0.65, 1))
```

Parameters of the gamma distribution from the proposed approach and the estimated
young water fraction (with user-defined age thresholds).

```{r, fig.width=10,fig.height=3, fig.align = 'center', eval = TRUE}

# Get Fyw for 100 best parameter sets
for(catchment in 1:2){
  Fywater <- c()
  for (simulation in 1:nrow(revisedProcedure$fitGamma[[1]]$parameterSet)){
  Fywater <- c(Fywater, pgamma(q = traditionalProcedure$tauyw[catchment],
                               shape = revisedProcedure$fitGamma[[catchment]]$parameterSet$alpha[simulation],
                               scale = revisedProcedure$fitGamma[[catchment]]$parameterSet$beta[simulation],
                               lower.tail = TRUE))
 }
  revisedProcedure$fitGamma[[catchment]]$parameterSet$Fyw <- Fywater
}
```

Compare results (parameter of the transit time - gamma distribution and the Fyw)
between the proposed and the traditional procedures

```{r, fig.width=10,fig.height=3, fig.align = 'center', eval = TRUE}

  # Create annotate text
  annotateText <- c("(a) Alp", "(b) Erlenbach")

  # Create a list object to store plot
  plt <- list()

  # Now plot the data
  for(i in 1:2){

    # Create data frame containing results from the traditional procedure
    addPoints <- data.frame(values = c(traditionalProcedure$alpha[i],
                                       traditionalProcedure$beta[i],
                                       traditionalProcedure$Fyw[i]), 
                            ind = c("alpha","beta", "Fyw"))
    
    # Plot parameters of the transit time (gamma) distribution and Fyw from the proposed vs. traditional procedures
    plt[[i]] <- ggplot(stack(revisedProcedure$fitGamma[[i]]$parameterSet[,c(4,5,6)]))+
      geom_boxplot(aes(x = ind, 
                       y = values, 
                       fill = ind), 
                   outlier.shape = NA)+
      geom_point(data = addPoints, 
                 aes(x = ind, 
                     y = values, 
                     fill = ind, 
                     shape = "1"), 
                 size = 2, 
                 color = "blue")+
      labs(x = "", 
           y = " ", 
           title = annotateText[i]) +  
      facet_wrap(. ~ ind, scales = "free")+
      scale_fill_manual(name = "", 
                        values = c("#f8766d", "#7cae00", "#00bfc4"))+
      scale_shape_manual(name = "", 
                         labels = c("traditional procedure"), 
                         values = c(16))+
      guides(shape = guide_legend(override.aes = 
                                    list(shape = c(16), 
                                         color = c("blue"))), 
             fill = guide_legend(override.aes = list(shape = NA) )) +
      theme_bw()+ 
      theme(legend.position = "none") 
 
 # Add legend to second plot
 if (i == 2) plt[[i]] <- plt[[i]] + theme(legend.position = "right")
}

# Arrange and display plot
ggarrange(plt[[1]], plt[[2]], ncol = 2, nrow = 1, widths = c(0.65, 1))
```


## 4. Effect of sampling frequency
### 4.1 Data processing and scenarios

From the original data (daily data with missing). We used linear interpolation to
get continuous daily data (without missing). This interpolation technique is applied 
to precipitation, streamflow, and isotope in precipitation and streamflow. 

```{r, eval = TRUE}

# Interpolate to have daily data
isotopePinter <- list()
isotopeSinter <- list()

# Loop over the catchment
for (icatchment in 1:2){ # 1 = alph, 2 = Erlenbach

  # Get daily continuous isotope data in precipitation
  dateNumeric <- as.numeric(isotopeP[[icatchment]]$date)
  dateInter <- c(dateNumeric[1]:dateNumeric[length(dateNumeric)])
  isotopePinter[[icatchment]] <- tibble(
    date = as.Date(dateInter),
    water_flux_mm = approx(dateNumeric, 
                           isotopeP[[icatchment]]$water_flux_mm, 
                           xout = dateInter, 
                           method = "linear")$y,
    delta_18O = approx(dateNumeric, 
                       isotopeP[[icatchment]]$delta_18O, 
                       xout = dateInter, 
                       method = "linear")$y)

  # Get daily continuous isotope data in streamflow
  dateNumeric <- as.numeric(isotopeS[[icatchment]]$date)
  dateInter <- c(dateNumeric[1]:dateNumeric[length(dateNumeric)])
  isotopeSinter[[icatchment]] <- tibble(
    date = as.Date(dateInter),
    water_flux_mm = approx(dateNumeric, 
                           isotopeS[[icatchment]]$water_flux_mm, 
                           xout = dateInter, 
                           method = "linear")$y,
    delta_18O = approx(dateNumeric, 
                       isotopeS[[icatchment]]$delta_18O, 
                       xout = dateInter, 
                       method = "linear")$y)
}

# Now prepare weekly and monthly data
dateInterval <- c(1, 7, 14, 30)
isotopeInter <- list()

for (icatchment in 1:2){
  
  # Results as list object
  isotopeInter$catchment[[icatchment]] <- list()

  for (j in 1:length(dateInterval)){
    # find commonly date of P and S data
    isotopeInter$catchment[[icatchment]]$dateInterVal[[j]] <- list()

    # Precipitation
    commonDate <- as.Date(intersect(isotopePinter[[icatchment]]$date, 
                                    isotopeSinter[[icatchment]]$date))
    
    commonDate <- seq(from = commonDate[2], 
                      to = commonDate[length(commonDate)], 
                      by = dateInterval[j])
    
    icommonDate <- which(isotopePinter[[icatchment]]$date %in% commonDate)
    isotopeInter$catchment[[icatchment]]$dateInterVal[[j]]$P <- isotopePinter[[icatchment]][icommonDate,]

    # Streamflow
    icommonDate <- which(isotopeSinter[[icatchment]]$date %in% commonDate)
    isotopeInter$catchment[[icatchment]]$dateInterVal[[j]]$S <- isotopeSinter[[icatchment]][icommonDate,]
  }
}
```

Plot to see the original and interpolated data at different time intervals (e.g., for the Alp catchment)

```{r, eval = TRUE, fig.width=12, fig.height=3, fig.align = 'center'}

# This is and example of plot for daily and monthly sampling interval for instream isotope
plt <- list()
samplingInterval <- c("Alp - daily", "Alp - weekly", "Alp - bi-weekly", "Alp - monthly")
for (i in 1:4){
  plt[[i]] <- ggplot()+
    geom_point(data = isotopeInter$catchment[[1]]$dateInterVal[[1]]$S, 
               aes(x = date, 
                   y = delta_18O, 
                   color = "daily sampling"), 
               shape = 1, 
               size = 1, 
               alpha = 0.5)+
    geom_point(data = isotopeInter$catchment[[1]]$dateInterVal[[i]]$S, 
               aes(x = date, 
                   y = delta_18O, 
                   color = "monthly sampling"), 
               shape = 3, 
               alpha = 1)+
    scale_color_manual(values = c("daily sampling" = "gray", 
                                  "monthly sampling" = "red"), 
                       guide = guide_legend(override.aes = list(shape = c(1, 3))))+
    labs(x = "", 
         y = expression(paste(delta^{18}, "O in streamflow (‰)")), 
         title = samplingInterval[i],
         color = "")+
    theme_bw() +
    theme(legend.position = "none")
}


ggarrange(plt[[2]], plt[[3]], plt[[4]], ncol = 3, nrow = 1)
  
```


### 4.2 Find Fyw

```{r, eval = FALSE}
for (icatchment in 1:2){
  
  # Loop over number of date interval
  for (j in 1:length(dateInterval)){

    # Fit sine wave to P observed data
    isotope_P <- isotopeInter$catchment[[icatchment]]$dateInterVal[[j]]$P
    isotope_S <- isotopeInter$catchment[[icatchment]]$dateInterVal[[j]]$S

    # convert date to decimal
    tP <- decimal_date(isotope_P$date) - trunc(decimal_date(isotope_P$date))
    tS <- decimal_date(isotope_S$date) - trunc(decimal_date(isotope_S$date))

    # Fit to sine wave to observed isotope data in precipitation
    fitSineP <- fitSineNL(observed = isotope_P$delta_18O, 
                          a = c(1,3), 
                          phi = c(0, 2*pi), 
                          k = c(-12,-8), 
                          t = isotope_P$date, 
                          nIter = 100000,
                          nBestIter = 100, 
                          weight = isotope_P$water_flux_mm, 
                          setSeed = 2023)

    # Fit Gamma using observed instream isotope composition
    simC <- fitGamma(AP = fitSineP$parameter$a, 
                     phiP = fitSineP$parameter$phi,
                     kP = fitSineP$parameter$k, 
                     alphaRange = c(0.01,5),
                     betaRange = c(0.01,5), 
                     simulatedDate = isotope_S$date,
                     fittedData = isotope_S$delta_18O, 
                     weight = isotope_S$water_flux_mm,
                     nIter = 100000, 
                     nBestIter = 100, 
                     nCores =100, 
                     nWarmupYears = 10,
                     setSeed = 2023)

    # Save data
    isotopeInter$catchment[[icatchment]]$dateInterVal[[j]]$fitSineP <- fitSineP
    isotopeInter$catchment[[icatchment]]$dateInterVal[[j]]$simC <- simC
  }
}
```


Plot the estimated young water fractions for the Alp and Erlenbach catchments 

```{r, fig.width = 7,fig.height = 5, fig.align = 'center'}
# Load data (if users does not run the model)
load("data/isotopeInter.rda")

# Calculate Fyw
for (icatchment in 1:2){
  
  # Loop over number of date interval
  for (j in 1:4){
    parameter <- isotopeInter$catchment[[icatchment]]$dateInterVal[[j]]$simC$parameterSet
    
    for (sim in 1:100){
      temp <- tibble::tibble(Fyw = pgamma(c(2/12, 3/12), 
                                          shape = parameter$alpha[sim], 
                                          scale = parameter$beta[sim], 
                                          lower.tail = TRUE), 
                             catchment = icatchment, 
                             timeStep = j, 
                             tau  = c(2,3))
      
      if (icatchment + j + sim == 3){
        Fywater <- temp
      } else {
        Fywater <- rbind(Fywater, temp)
      }
    }
  }
  
}

# Create annotate Text
annoText <- data.frame(Fyw = c(rep(1,4)), 
                       timeStep = rep(3,4), 
                       catchment = c(1,1,2,2),
                       tau = c(2,3,2,3),
                       label = c("(a) Alp (2 months)",
                                 "(b) Alp (3 months)",
                                 "(c) Erlenbach (2 months)", 
                                 "(d) Erlenbach (3 months)"))

# Plot Fyw
ggplot(Fywater)+
  geom_boxplot(aes(x = timeStep, 
                   y = Fyw, 
                   group = timeStep,
                   fill = as.character(timeStep)), 
               alpha = 0.8)+
  facet_wrap(~ catchment + tau, ncol = 2)+
  scale_x_discrete(limits=c("#f8766d", "#7cae00", "#00bfc4", "#fcdf03"),
                   labels=c("daily", "weekly", "bi-weekly", "monthly")) +
  scale_fill_manual(name = " ", 
                    labels = c("daily", "weekly", "bi-weekly", "monthly"),
                    values = c("#f8766d", "#7cae00", "#00bfc4", "#fcdf03"))+
  labs(x = "", 
       y = expression(F[yw])) +
  theme_bw()+ ylim(0,1) + 
  theme(legend.position = "top", 
        strip.text.x = element_blank()) +
  geom_text(data = annoText, 
            aes(x = timeStep, 
                y = Fyw, 
                label = label, 
                fontface = "bold"), 
            size = 3.5)

```

## 5. Supplement code for figures

```{r, eval = FALSE}
# Load function for ploting figures 1 to 5
source('R/plotFig1.R')
source('R/plotFig2.R')
source('R/plotFig3.R')
source('R/plotFig4.R')
source('R/plotFig5.R')

# Plot figure 1 to 5
figure1 <- plotFig1(isotopeData)
figure2 <- plotFig2(isotopeP, isotopeS, traditionalProcedure, revisedProcedure)
figure3 <- plotFig3(revisedProcedure, traditionalProcedure)
figure4 <- plotFig4(Fywater)
figure5 <- plotFig5(isotopeInter)

# NOTE: figure3 was subjected to minor edits using Inkscape (https://inkscape.org/)
```


### References
